<html>
	<head>
	<link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	<script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<title>
		server_tests.cpp
	</title>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
#include &lt;boost/test/unit_test.hpp&gt;

#include &lt;beast/core.hpp&gt;
#include &lt;json.hpp&gt;
#include "../network/server.h"

// simple sync client for server testing
struct Client {
	boost::asio::io_service ios;
	boost::asio::ip::tcp::resolver resolver;
	boost::asio::ip::tcp::socket socket;
	beast::websocket::stream&lt;boost::asio::ip::tcp::socket&amp;&gt; ws;
	beast::streambuf buffer;
	beast::websocket::opcode op;

	Client()
<span style = "background-color:#dfd">		: resolver(ios)
		, socket(ios)
		, ws(socket)
	{}</span>

	void write(const std::string&amp; msg)
<span style = "background-color:#dfd">	{
		ws.write(boost::asio::buffer(msg));
	}</span>

	const std::string read()
<span style = "background-color:#dfd">	{
		ws.read(op, buffer);
		auto message = beast::to_string(buffer.data());
		buffer.consume(buffer.size());
		return message;
	}</span>

	void connect()
<span style = "background-color:#dfd">	{
		boost::system::error_code error_code;
		boost::asio::connect(socket, resolver.resolve(boost::asio::ip::tcp::resolver::query{ "127.0.0.1", "2137" }), error_code);
		ws.handshake("127.0.0.1", "/", error_code);
	}</span>

	void disconnect()
<span style = "background-color:#dfd">	{
		ws.close(beast::websocket::close_code::normal);
		ws.next_layer().close();
	}
};</span>

<span style = "background-color:#dfd">BOOST_AUTO_TEST_SUITE(SessionTests)
BOOST_AUTO_TEST_CASE(CreateSessionsAndGiveThemIds)
{
	boost::asio::io_service ios;
	SessionManager manager;
	boost::asio::ip::tcp::socket socket(ios);</span>

	// create 3 sessions
<span style = "background-color:#dfd">	std::shared_ptr&lt;Session&gt; session1 = std::make_shared&lt;Session&gt;(manager, std::move(socket));
	std::shared_ptr&lt;Session&gt; session2 = std::make_shared&lt;Session&gt;(manager, std::move(socket));
	std::shared_ptr&lt;Session&gt; session3 = std::make_shared&lt;Session&gt;(manager, std::move(socket));</span>

	// chceck whether their IDs are correct
<span style = "background-color:#dfd">	size_t base_id = session1-&gt;getId();
	BOOST_CHECK_EQUAL(session2-&gt;getId(), base_id + 1);
	BOOST_CHECK_EQUAL(session3-&gt;getId(), base_id + 2);
}
BOOST_AUTO_TEST_SUITE_END()</span>

<span style = "background-color:#dfd">BOOST_AUTO_TEST_SUITE(ManagerTests)
BOOST_AUTO_TEST_CASE(RegisterSessions)
{
	boost::asio::io_service ios;
	SessionManager manager;
	boost::asio::ip::tcp::socket socket(ios);</span>

	// no registered sessions
<span style = "background-color:#dfd">	BOOST_CHECK_EQUAL(manager.connected(), 0);</span>
	// create a session
<span style = "background-color:#dfd">	std::shared_ptr&lt;Session&gt; session1 = std::make_shared&lt;Session&gt;(manager, std::move(socket));</span>
	// register it
<span style = "background-color:#dfd">	manager.registerSession(session1);</span>
	// check whether it is registered correctly
<span style = "background-color:#dfd">	BOOST_CHECK_EQUAL(manager.connected(), 1);</span>
	// another one
<span style = "background-color:#dfd">	std::shared_ptr&lt;Session&gt; session2 = std::make_shared&lt;Session&gt;(manager, std::move(socket));</span>
	// register...
<span style = "background-color:#dfd">	manager.registerSession(session2);</span>
	// check...
<span style = "background-color:#dfd">	BOOST_CHECK_EQUAL(manager.connected(), 2);
}</span>

<span style = "background-color:#dfd">BOOST_AUTO_TEST_CASE(UnregisterSessions)
{
	boost::asio::io_service ios;
	SessionManager manager;
	boost::asio::ip::tcp::socket socket(ios);</span>

	// register two sessions
<span style = "background-color:#dfd">	std::shared_ptr&lt;Session&gt; session1 = std::make_shared&lt;Session&gt;(manager, std::move(socket));
	manager.registerSession(session1);
	std::shared_ptr&lt;Session&gt; session2 = std::make_shared&lt;Session&gt;(manager, std::move(socket));
	manager.registerSession(session2);
	BOOST_CHECK_EQUAL(manager.connected(), 2);</span>

	// remove them one by one
<span style = "background-color:#dfd">	manager.unregisterSession(session1-&gt;getId());
	BOOST_CHECK_EQUAL(manager.connected(), 1);
	manager.unregisterSession(session2-&gt;getId());
	BOOST_CHECK_EQUAL(manager.connected(), 0);</span>

	// try to remove not existing session
<span style = "background-color:#dfd">	BOOST_CHECK_THROW(manager.unregisterSession(session1-&gt;getId()), std::runtime_error);
}
BOOST_AUTO_TEST_SUITE_END()</span>

<span style = "background-color:#dfd">BOOST_AUTO_TEST_SUITE(ServerTests)
BOOST_AUTO_TEST_CASE(StartAndStopServer)
{</span>
	// start a server and check if its accepting new connections
<span style = "background-color:#dfd">	Server server;
	server.run(2137);
	BOOST_CHECK(server.isAccepting());</span>

	// stop and check again
<span style = "background-color:#dfd">	server.stop();
	BOOST_CHECK(!server.isAccepting());
}</span>

<span style = "background-color:#dfd">BOOST_AUTO_TEST_CASE(WriteAndReadWithWebsocket)
{
	Server server;
	server.run(2137);</span>

	// connect with one client and receive welcome message
<span style = "background-color:#dfd">	Client client1;
	client1.connect();
	auto json = json::parse(client1.read().c_str());
	BOOST_CHECK(json["action"] == "welcome");</span>
	
	// connect with another client
<span style = "background-color:#dfd">	Client client2;
	client2.connect();
	json = json::parse(client2.read().c_str());
	BOOST_CHECK(json["action"] == "welcome");</span>

	// send a message to server
<span style = "background-color:#dfd">	json.clear();
	json["action"] = "show";
	client2.write(json.dump());</span>

	// receive response
<span style = "background-color:#dfd">	json = json::parse(client2.read().c_str());
	BOOST_CHECK(json["action"] == "show");</span>

<span style = "background-color:#dfd">	client1.disconnect();
	client2.disconnect();
}
BOOST_AUTO_TEST_SUITE_END()</span></pre>
	</body>
</html>